var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,c){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(c)},unbind:function(a,c){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(c),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger"],f=0;f<c.length;f++)a.prototype[c[f]]=MicroEvent.prototype[c[f]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};
function FourierTransform(a,c){this.bufferSize=a;this.sampleRate=c;this.bandwidth=2/a*c/2;this.spectrum=new Float32Array(a/2);this.real=new Float32Array(a);this.imag=new Float32Array(a);this.peak=this.peakBand=0;this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2};this.calculateSpectrum=function(){for(var c=this.spectrum,d=this.real,e=this.imag,k=2/this.bufferSize,j=Math.sqrt,h,m,n=0,q=a/2;n<q;n++)h=d[n],m=e[n],h=k*j(h*h+m*m),h>this.peak&&(this.peakBand=n,this.peak=h),c[n]=
h}}function DFT(a,c){FourierTransform.call(this,a,c);var f=a/2*a,d=2*Math.PI;this.sinTable=new Float32Array(f);this.cosTable=new Float32Array(f);for(var e=0;e<f;e++)this.sinTable[e]=Math.sin(e*d/a),this.cosTable[e]=Math.cos(e*d/a)}DFT.prototype.forward=function(a){for(var c=this.real,f=this.imag,d,e,k=0;k<this.bufferSize/2;k++){for(var j=e=d=0;j<a.length;j++)d+=this.cosTable[k*j]*a[j],e+=this.sinTable[k*j]*a[j];c[k]=d;f[k]=e}return this.calculateSpectrum()};
function FFT(a,c){FourierTransform.call(this,a,c);this.reverseTable=new Uint32Array(a);for(var f=1,d=a>>1,e;f<a;){for(e=0;e<f;e++)this.reverseTable[e+f]=this.reverseTable[e]+d;f<<=1;d>>=1}this.sinTable=new Float32Array(a);this.cosTable=new Float32Array(a);for(e=0;e<a;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)}
FFT.prototype.forward=function(a){var c=this.bufferSize,f=this.cosTable,d=this.sinTable,e=this.reverseTable,k=this.real,j=this.imag,h=Math.floor(Math.log(c)/Math.LN2);if(Math.pow(2,h)!==c)throw"Invalid buffer size, must be a power of 2.";if(c!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+c+" Buffer Size: "+a.length;var h=1,m,n,q,p,t,g;for(g=0;g<c;g++)k[g]=a[e[g]],j[g]=0;for(;h<c;){a=f[h];e=d[h];m=1;for(var s=n=0;s<h;s++){for(g=s;g<c;)q=g+h,p=m*k[q]-n*j[q],t=m*j[q]+
n*k[q],k[q]=k[g]-p,j[q]=j[g]-t,k[g]+=p,j[g]+=t,g+=h<<1;g=m;m=g*a-n*e;n=g*e+n*a}h<<=1}return this.calculateSpectrum()};
FFT.prototype.inverse=function(a,c){var f=this.bufferSize,d=this.cosTable,e=this.sinTable,k=this.reverseTable;a=a||this.real;c=c||this.imag;var j=1,h,m,n,q,p,t,g;for(g=0;g<f;g++)c[g]*=-1;h=new Float32Array(f);m=new Float32Array(f);for(g=0;g<a.length;g++)h[g]=a[k[g]],m[g]=c[k[g]];a=h;for(c=m;j<f;){k=d[j];h=e[j];m=1;for(var s=n=0;s<j;s++){for(g=s;g<f;)q=g+j,p=m*a[q]-n*c[q],t=m*c[q]+n*a[q],a[q]=a[g]-p,c[q]=c[g]-t,a[g]+=p,c[g]+=t,g+=j<<1;g=m;m=g*k-n*h;n=g*h+n*k}j<<=1}d=new Float32Array(f);for(g=0;g<f;g++)d[g]=
a[g]/f;return d};
function RFFT(a,c){FourierTransform.call(this,a,c);this.trans=new Float32Array(a);this.reverseTable=new Uint32Array(a);this.reverseBinPermute=function(a,c){var e=this.bufferSize,k=e>>>1,e=e-1,j=1,h=0,m;a[0]=c[0];do{h+=k;a[j]=c[h];a[h]=c[j];j++;for(m=k<<1;m>>=1,!((h^=m)&m););h>=j&&(a[j]=c[h],a[h]=c[j],a[e-j]=c[e-h],a[e-h]=c[e-j]);j++}while(j<k);a[e]=c[e]};this.generateReverseTable=function(){var a=this.bufferSize,c=a>>>1,a=a-1,e=1,k=0,j;this.reverseTable[0]=0;do{k+=c;this.reverseTable[e]=k;this.reverseTable[k]=
e;e++;for(j=c<<1;j>>=1,!((k^=j)&j););k>=e&&(this.reverseTable[e]=k,this.reverseTable[k]=e,this.reverseTable[a-e]=a-k,this.reverseTable[a-k]=a-e);e++}while(e<c);this.reverseTable[a]=a};this.generateReverseTable()}
RFFT.prototype.forward=function(a){var c=this.bufferSize,f=this.spectrum,d=this.trans,e=2*Math.PI,k=Math.sqrt,j=c>>>1,h=2/c,m,n,q,p,t,g,s,r,x,v,u,C,D,E,G,z,A,B,H,I,J;this.reverseBinPermute(d,a);p=0;for(var y=4;p<c;y*=4){for(var w=p;w<c;w+=y)z=d[w]-d[w+1],d[w]+=d[w+1],d[w+1]=z;p=2*(y-1)}a=2;for(q=c>>>1;q>>>=1;){p=0;a<<=1;y=a<<1;m=a>>>2;n=a>>>3;do{if(1!==m)for(w=p;w<c;w+=y)r=w,x=r+m,v=x+m,u=v+m,p=d[v]+d[u],d[u]-=d[v],d[v]=d[r]-p,d[r]+=p,r+=n,x+=n,v+=n,u+=n,p=d[v]+d[u],t=d[v]-d[u],p=-p*Math.SQRT1_2,
t*=Math.SQRT1_2,z=d[x],d[u]=p+z,d[v]=p-z,d[x]=d[r]-t,d[r]+=t;else for(w=p;w<c;w+=y)r=w,x=r+m,v=x+m,u=v+m,p=d[v]+d[u],d[u]-=d[v],d[v]=d[r]-p,d[r]+=p;p=(y<<1)-a;y<<=2}while(p<c);J=e/a;for(var F=1;F<n;F++){A=F*J;B=Math.sin(A);A=Math.cos(A);H=4*A*(A*A-0.75);I=4*B*(0.75-B*B);p=0;y=a<<1;do{for(w=p;w<c;w+=y)r=w+F,x=r+m,v=x+m,u=v+m,C=w+m-F,D=C+m,E=D+m,G=E+m,t=d[E]*A-d[v]*B,p=d[E]*B+d[v]*A,s=d[G]*H-d[u]*I,g=d[G]*I+d[u]*H,z=t-s,t+=s,s=z,d[G]=t+d[D],d[v]=t-d[D],z=g-p,p+=g,g=z,d[u]=g+d[x],d[E]=g-d[x],d[D]=d[r]-
p,d[r]+=p,d[x]=s+d[C],d[C]-=s;p=(y<<1)-a;y<<=2}while(p<c)}}for(;--j;)e=d[j],a=d[c-j-1],e=h*k(e*e+a*a),e>this.peak&&(this.peakBand=j,this.peak=e),f[j]=e;f[0]=h*d[0];return f};(function(a){for(i in a)if(!window[i])throw"Error: ThreeAudio requires "+a[i];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(a){var c=document.getElementById(a);return c&&(c.innerText||c.textContent)||a};window._=window._||{};
_.each=_.each||function(a,c){if(a.forEach)return a.forEach(c);for(key in a)c(a[key],key,a)};_.extend=_.extend||function(a){_.each([].slice.call(arguments,1),function(c){for(var f in c)a[f]=c[f]});return a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger","on","emit"],f=0;f<c.length;f++)a.prototype[c[f]]=MicroEvent.prototype[c[f]]};ThreeAudio.toTexture=function(a){return ThreeRTT&&ThreeRTT.toTexture&&ThreeRTT.toTexture(a)||a};var \u03c0=Math.PI,\u03c4=2*\u03c0;
ThreeAudio.Source=function(a){"number"==typeof a&&(a={fftSize:a});a=_.extend({fftSize:1024,levels:!0,beats:!0},a);this.fftSize=a.fftSize;this.levels=a.levels;this.beats=a.beats;this.filters={};this.buffer=null;this.playing=!1;this.seek=0;this.init()};
ThreeAudio.Source.prototype={init:function(){var a=this.context=new webkitAudioContext;this.audible=a.createDelayNode();this.inaudible=a.createDelayNode();this.analyser=a.createAnalyser();var c=this.analyser.fftSize=this.fftSize,f=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:500,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(d,e){var h=a.createBiquadFilter();h.key=e;h.type=d.type;h.frequency.value=d.frequency;h.Q.value=d.Q;h.analyser=a.createAnalyser();
h.analyser.fftSize=c;h.delayNode=a.createDelayNode();h.delayNode.delayTime.value=0;h.gainNode=a.createGainNode();h.gainNode.gain.value=d.gain;f[e]=h});this.delay=a.createDelayNode();this.delay.delayTime.value=2*this.fftSize/a.sampleRate;this.audible.connect(this.analyser);this.inaudible.connect(this.analyser);this.audible.connect(this.delay);this.delay.connect(a.destination);var d=this.audible,e=this.inaudible;_.each(f,function(a){d.connect(a.delayNode);e.connect(a.delayNode);a.delayNode.connect(a);
a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.samples=this.analyser.frequencyBinCount;this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(this.samples),mid:new Uint8Array(this.samples),treble:new Uint8Array(this.samples)}};this.levels&&(this.levelDetect=new ThreeAudio.LevelDetect(this.data));this.beats&&(this.beatDetect=new ThreeAudio.BeatDetect(this.data))},update:function(){var a=this.analyser,c=this.data;a.smoothingTimeConstant=
0;a.getByteFrequencyData(c.freq);a.getByteTimeDomainData(c.time);_.each(this.filters,function(a){a.analyser.getByteTimeDomainData(c.filter[a.key])});this.levels&&this.levelDetect.analyse();this.beats&&this.beatDetect.analyse();return this},size:function(){return this.analyser.frequencyBinCount},mic:function(a){var c=this.context,f=this.inaudible;try{navigator.webkitGetUserMedia({audio:!0},function(d){(this.mediaStreamSource=c.createMediaStreamSource(d)).connect(f);a&&a()})}catch(d){}return this},
immediate:function(a){this.buffer=this.context.createBuffer(a,!1);this.playing&&that._play();return this},load:function(a,c){var f=this.context,d=this,e=new XMLHttpRequest;e.open("GET",a,!0);e.responseType="arraybuffer";e.onload=function(){d.buffer=f.createBuffer(e.response,!1);d.playing&&d._play();c&&c()};e.send();return this},play:function(){if(!this.playing)return this.playing=!0,this.buffer&&this._play(),this},stop:function(){if(this.playing)return this.playing=!1,this.buffer&&this._stop(),this},
_play:function(){this.bufferSource=this.context.createBufferSource();this.bufferSource.connect(this.audible);this.bufferSource.buffer=this.buffer;this.bufferSource.noteOn(0);this.startTime=+new Date-this.seek},_stop:function(){this.bufferSource.noteOff(0);this.bufferSource.disconnect(0)},time:function(){return this.startTime?+new Date-this.startTime:0}};ThreeAudio.Source.prototype.start=ThreeAudio.Source.prototype.play;
ThreeAudio.Material=function(a,c,f,d,e,k){k=k||[];e=_.extend(e||{},{audioIsBeat:{type:"f",value:0},audioWasBeat:{type:"f",value:0},audioLevels:{type:"fv1",value:[0,0,0,0]},audioLevelsSmooth:{type:"fv1",value:[0,0,0,0]},audioLevelsChange:{type:"fv1",value:[0,0,0,0]},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}});_.each(a.get(),function(a,c){var d=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);
d.__webglInit=!0;d.__webglTexture=a;e[c+"Data"]={type:"t",value:d}});_.each(d||[],function(a,c){e[c]={type:"t",value:ThreeAudio.toTexture(a)}});a.on("update",function(a){_.each(a,function(a,c){e[c].value=a})});return new THREE.ShaderMaterial({attributes:k,uniforms:e,vertexShader:ThreeAudio.getShader(c),fragmentShader:ThreeAudio.getShader(f)})};ThreeAudio.Textures=function(a,c,f){this.renderer=a;this.source=c;this.textures={};this.history=f||128;this.timeIndex=0;this.data=c.data;this.init()};
ThreeAudio.Textures.prototype={init:function(){var a=this.renderer,c=a.getContext(),f=this.textures,d=this.data,e=this.history,k,j,h;_.each(["freq","time"],function(m){f[m]&&(c.deleteTexture(f[m]),a.info.memory.textures--);k=f[m]=c.createTexture();a.info.memory.textures++;c.bindTexture(c.TEXTURE_2D,k);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.LINEAR);j=d[m];h=new Uint8Array(j.length*e);if("time"==m)for(m=0;m<j.length*e;++m)h[m]=128;c.texImage2D(c.TEXTURE_2D,0,c.ALPHA,j.length,e,0,c.ALPHA,c.UNSIGNED_BYTE,h)})},update:function(){var a=this.renderer.getContext(),c=this.textures,f=this.source,d=this.history,e=this.timeIndex,k=f.data;f.update();_.each(["freq","time"],function(d){a.bindTexture(a.TEXTURE_2D,c[d]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,e,k[d].length,1,a.ALPHA,a.UNSIGNED_BYTE,
k[d])});this.emit("update",this.uniforms());this.timeIndex=(e+1)%d},get:function(){return this.textures},uniforms:function(){var a=this.data.levels,c=this.data.beat;return{audioIsBeat:c&&c.is||0,audioWasBeat:c&&c.was||0,audioLevels:a&&a.direct||0,audioLevelsSmooth:a&&a.smooth||0,audioLevelsChange:a&&a.change||0,audioOffset:this.timeIndex/this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);
ThreeAudio.GridGeometry=function(a,c,f,d,e){var k=a.source;d=(d||k.samples)-1;e=Math.min(a.history,e||a.history)-1;var j=e/a.history,h=0.5/(k.samples-1);offsetV=0.5/a.history;a=new THREE.PlaneGeometry(c,f,d,e);_.each(a.faceVertexUvs[0],function(a){_.each(a,function(a){a.u+=h;a.v=1-a.v*j+offsetV})});return a};ThreeAudio.LevelDetect=function(a){this.data=a;this.levels=[[0,0,0,0]];this.smooth=[0,0,0,0];this.change=[0,0,0,0];a.levels={direct:this.levels[0],smooth:this.smooth,change:this.change}};
ThreeAudio.LevelDetect.prototype.analyse=function(){for(var a=this.data,c=this.levels,f=this.smooth,d=this.change,e=[0,0,0,0],k=[a.time,a.filter.bass,a.filter.mid,a.filter.treble],a=0;4>a;++a){var j=e,h=a,m;m=k[a];for(var n=m.length,q=0,p=0;p<n;++p)var t=(m[p]-128)/128,q=q+t*t;m=Math.sqrt(q/n);j[h]=m}c.unshift(e);7<c.length&&c.pop();k=[1,2,1];j=4;h=Math.min(c.length,k.length);for(m=0;4>m;++m){for(a=e=0;a<h;++a)e+=(c[a]&&c[a][m]||0)*k[a];f[m]=e/j}k=[1,3,2,-2,-3,-1];j=6;Math.min(c.length,k.length);
for(m=0;4>m;++m){for(a=e=0;a<h;++a)e+=(c[a]&&c[a][m]||0)*k[a];d[m]+=0.5*(e/j-d[m])}this.data.levels.direct=this.levels[0]};var __taDebug=!1;
ThreeAudio.BeatDetect=function(a){this.data=a;a.beat={permanence:0,confidence:0,missed:!1,predicted:!1,maybe:!1,is:!1,was:0,stddev:0,bpm:0};__taDebug&&this.initDebug();this.n=512;this.history=[[],[],[]];this.buffer=new Float32Array(this.n);this.spectrum=null;this.fft=new FFT(this.n,44100);this.decay=this.debouncePredict=this.debounceMaybe=this.maxMaybe=this.maybe=this.measure=this.signal=this.energy=this.background=this.sample=0;this.intervals=[];this.jitter=this.stddev=this.mean=0;this.missed=3;
this.found=0;this.predicted=!1;this.green=0;this.fMin=Math.floor(this.bpmToOffset(50));this.fMax=Math.ceil(this.bpmToOffset(400));this.histogram={};this.histogramSorted=[];this.beat=null;this.frames=0};
ThreeAudio.BeatDetect.prototype={initDebug:function(){this.c=document.createElement("canvas");this.c.className="ta-debug";this.c.width=512;this.c.height=340;this.c.style.position="absolute";this.c.style.zIndex=20;this.c.style.marginTop="70px";this.c.style.top=0;this.g=this.c.getContext("2d");this.i=0;this.t=document.createElement("div");this.t.className="ta-debug";this.t.width=256;this.t.height=200;this.t.style.background="rgba(0,0,0,.3)";this.t.style.color="#fff";this.t.style.fontSize="10px";this.t.style.position=
"absolute";this.t.style.zIndex=20;this.t.style.marginTop="350px";this.c.style.top=0;document.body.appendChild(this.c);document.body.appendChild(this.t)},bpmToOffset:function(a){return this.n*a/3600},offsetToBPM:function(a){return 3600*a/this.n},analyse:function(){var a=this.data,c=a.levels,f=this.buffer,d=this.fft,e=this.n,k=this.history,j=this.histogram,h=this.histogramSorted,m=this;a.beat.missed=!1;a.beat.maybe=!1;a.beat.is=!1;a.beat.predicted=!1;a.beat.locked=!1;a.beat.adjusted=!1;this.beat?(a.beat.confidence=
this.beat.confidence,a.beat.permanence=this.beat.permanence,a.beat.bpm=this.beat.bpm):(a.beat.confidence=0,a.beat.permanence=0,a.beat.bpm="");var n=c.direct[0];this.background+=0.2*(n-this.background);this.energy+=0.4*(n-this.energy);this.signal=n=3*((this.energy-this.background)/(1-this.background));c=this.maybe;maybe=n;this.maxMaybe=Math.max(0.99*this.maxMaybe,maybe);this.maybe=maybe=maybe/Math.max(0.2,this.maxMaybe)-0.7;this.sample=n;for(k.unshift(n);k.length>e;)k.pop();f.set(k);d.forward(f);for(var q=
this.spectrum=d.real,n=d.real,f=d.imag,d=0;d<e;++d)q[d]=n[d]*n[d]+f[d]*f[d];f=0;for(d=2;d<e/8;++d)f=Math.max(f,q[d]);for(var k={},p=f/16,d=this.fMin+1;d<this.fMax;++d)if(n=q[d],n>p){var t=Math.max(q[d-1],q[d+1]);if(n>t&&(t=Math.min(q[d-1],q[d+1]),0.5<Math.abs(n-t)/n)){var g=Math.sqrt(n/f);k[d]=g}}_.each(h,function(a){a.permanence*=0.99;decay=Math.min(1,Math.log(1+a.permanence)/Math.log(10));a.strength*=decay;a.active=!1});_.each(k,function(a,c){c=+c;var d=q[c-1],g=q[c+1],f=d+g-2*q[c];b=(g-d)/2;fraction=
-b/f;d=j[c];d||((d=j[c+1])?(delete j[c+1],d.index=c,d.fraction+=1,j[c]=d):(d=j[c-1])?(delete j[c-1],d.index=c,d.fraction-=1,j[c]=d):(d=j[c]={index:c,fraction:fraction,offset:0,strength:0,permanence:0,score:0,window:0},h.push(d)));d.fraction+=0.1*(fraction-d.fraction);d.strength=a;d.permanence+=0.01*d.strength;d.offset=d.index+d.fraction;d.bpm=m.offsetToBPM(d.offset);d.window=e/d.offset;d.active=!0});h.sort(function(a,c){return c.permanence-a.permanence});for(var s;(s=h[h.length-1])&&0.01>s.strength;)h.splice(h.length-
1,1),delete j[s.index];var r=this.fMin,x=0,v=0,u=null;_.each(h,function(a){var c=0;if(!(a.offset<r)){var d,e=0,f=1.5*a.offset;_.each(h,function(c){if(c!=a&&!(c.offset<f)){var d=c.offset/a.offset,h=Math.max(0,1-4*Math.abs(d-Math.round(d)));g=c.strength*c.permanence*d;e+=h*g}});d=e;d>c&&(c=d);c+=a.strength*a.permanence;a.score=c;c>x?(u=a,v=x,x=c):c>v&&(v=c)}});u&&(u.score=x?1-v/x:0,u.confidence=Math.min(1,u.score+u.permanence),this.beat?this.beat.confidence<u.confidence?this.beat=u:this.beat!=u&&(this.beat.confidence*=
0.95):this.beat=u,240<this.beat.bpm&&(this.beat.bpm/=2,this.beat.window*=2));s=this.measure;d=0;this.beat&&(d=this.beat.window,this.mean&&2>this.stddev&&(d=this.mean,a.beat.locked=!0,a.beat.bpm=this.offsetToBPM(this.n/d)));0<maybe&&(0>=c&&5<this.debounceMaybe)&&(this.debounceMaybe=0,!this.beat||!a.beat.locked&&0.3>this.beat.confidence?(this.measure=0,a.beat.is=!0,a.beat.maybe=!0):this.beat&&(c=this.beat.window/2,c=(this.measure+c)%d-c,n=this.jitter&&Math.max(3,Math.min(this.jitter+1,10))||10,Math.abs(c)<
n?(this.measure=0,1>=c&&5<this.debouncePredict||!this.predicted?(a.beat.is=!0,0<=c&&(a.beat.predicted=!0),this.debouncePredict=0,this.found=Math.min(10,this.found+1),a.beat.adjusted=!0):(a.beat.maybe=!0,this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-1)),this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)):maybe>1+0.2*this.found+0.5/this.stddev-this.missed/10||0==this.found||4<this.missed?(this.measure=0,a.beat.is=!0,this.debouncePredict=0,this.found=
Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)):a.beat.maybe=!0));if(this.beat&&0.3<this.beat.confidence){c=5<this.debouncePredict;if(n=this.measure>=d)this.measure-=d;n&&c&&(0>maybe?(this.found=Math.max(0,this.found-1),this.missed=Math.min(10,this.missed+1),a.beat.missed=!0,a.beat.predicted=!0):(this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)),1>this.found?(n=!1,a.beat.maybe=!0,a.beat.predicted=!0,this.debouncePredict=0):4<this.missed&&(n=!1,a.beat.maybe=
!0,a.beat.predicted=!0,this.measure+=5*Math.random(),this.debounceMaybe+=5*Math.random(),this.debouncePredict=0),this.predicted=n);n&&c&&(this.debouncePredict=0,a.beat.is=!0,a.beat.predicted=!0)}c=0;if(3<this.missed)this.green=0;else if(a.beat.is||a.beat.adjusted)this.green++&&(c=this.frames-this.lastGreen),this.lastGreen=this.frames;if(c&&(c=this.intervals,c.unshift(s),12<c.length&&c.pop(),c=c.slice(),c.sort(),c=c.slice(2,10),6<c.length)){n=s=0;l=c.length;for(d=0;d<l;++d)s+=c[d],n+=c[d]*c[d];s/=
l;n/=l;this.mean=s;this.stddev=Math.sqrt(n-s*s)}this.jitter=(this.stddev+0.5*this.missed)*(1+this.missed);this.decay+=0.4*(2.5*+a.beat.is-this.decay);a.beat.was+=0.4*(2.5*this.decay-a.beat.was);this.debounceMaybe++;this.debouncePredict++;this.measure++;this.frames++;__taDebug&&this.debug()},debug:function(){function a(a){a=Math.round(Math.max(0,Math.min(255,255*a)));g.fillStyle="rgb("+[a,a,a].join()+")";g.fillRect(r,x,1,20);x+=20}var c=this.data.levels.direct,f=this.sample,d=this.signal,e=this.maybe,
k=this.spectrum,j=this.histogram,h=this.data.beat,m=this,n=this.n;if(this.beat){var q=this.beat,p=1.5*q.offset;_.each(j,function(a){var c=a==q?1:0;a.offset>p&&(c=a.offset/q.offset,c=Math.max(0,1-4*Math.abs(c-Math.round(c))));a.match=c})}var t=["<strong><span"+(h.locked?' style="color: rgb(180,255,0)"':"")+">"+Math.round(10*h.bpm)/10+" BPM </span> ("+Math.round(100*h.confidence)+"%) P:"+Math.round(100*h.permanence)+" \u00b5 = "+Math.round(10*this.mean)/10+" \u03c3 = "+Math.round(100*this.stddev)/100+
"</strong> "+this.found+"f "+this.missed+"m"];_.each(j,function(a){var c=Math.round(10*m.offsetToBPM(a.offset))/10;t.push([c," bpm - ",Math.round(100*a.strength),"% P: ",Math.round(100*a.permanence)].join(""))});this.t.innerHTML=t.join("<br>");var g=this.g;g.fillStyle="#000000";g.fillRect(0,169,512,102);for(var s=0,r=2;r<n/8;++r)s=Math.max(k[r],s);s=1/s;g.beginPath();g.moveTo(0,270);for(r=2;r<n/8;++r)g.lineTo(8*(r-2),270-100*k[r]*s);g.strokeStyle="#ffffff";g.stroke();_.each(j,function(a){var c=0.75*
a.strength+0.25,d=a.active?[Math.round(255-195*a.match),Math.round(180+40*a.match),0].join():"255,10,10";g.fillStyle="rgba("+d+","+c+")";g.fillRect(8*(a.offset-2),170,1,100)});var r=this.i,x=0;a(c[1]);a(c[2]);a(c[3]);a(0);a(0);a(0);a(0);a(0);g.fillStyle="rgba(160,160,255,.85)";g.fillRect(r+1,0,2,120);h.is&&(g.fillStyle=h.missed?"rgba(255,0,0,.7)":h.maybe?"rgba(0,180,255,.9)":h.predicted?"rgba(255,200,0,1)":"rgba(60,220,0,1)",g.fillRect(this.i,120,2,40));c=Math.round(Math.max(0,Math.min(255,255*h.was)));
g.fillStyle="rgb("+c+","+c+","+c+")";g.fillRect(342,270,170,30);h.maybe&&!h.is&&(g.fillStyle="rgba(64,64,64,.75)",g.fillRect(this.i,120,2,40));f=Math.floor(255*Math.max(0,Math.min(1,1.4*f+0.5)));g.fillStyle="rgba("+Math.round(0.2*f)+","+Math.round(0.6*f)+","+f+",1)";g.fillRect(this.i,60,1,20);d=Math.floor(255*Math.max(0,Math.min(1,2*d)));g.fillStyle="rgba("+Math.round(0.2*d)+","+Math.round(d)+","+Math.round(0.5*d)+",1)";g.fillRect(this.i,80,1,20);e=h.is||h.maybe?Math.floor(255*Math.max(0,Math.min(1,
1.2*e+0.5))):0;g.fillStyle="rgba("+Math.round(e)+","+e+","+Math.round(e)+",1)";g.fillRect(this.i,100,1,20);this.i=(r+1)%512}};tQuery.World.registerInstance("audio",function(a){return tQuery.createAudioSource(this,a)});tQuery.registerStatic("createAudioSource",function(a,c){var f=new ThreeAudio.Source(c);f.textures=function(c){return tQuery.createAudioTextures(a,this,c)};return f});
tQuery.registerStatic("createAudioTextures",function(a,c,f){var d=new ThreeAudio.Textures(a.tRenderer(),c,f);d.material=function(a,c,d,h,f){return tQuery.createAudioMaterial(this,a,c,d,h,f)};a.loop().hookPreRender(function(){d.update()});return d});tQuery.registerStatic("createAudioMaterial",function(a,c,f,d,e,k){c=new ThreeAudio.Material(a,c,f,d,e,k);c.grid=function(c,d,e,f){return tQuery.createAudioGrid(a,c,d,e,f,this)};return c});
tQuery.registerStatic("createAudioGrid",function(a,c,f,d,e,k){var j=[a,1,1,0,0];for(i in j)arguments[i]=arguments[i]||j[i];j=new ThreeAudio.GridGeometry(a,c||1,f||1,d,e);k=k||tQuery.defaultObject3DMaterial;j=new THREE.Mesh(j,k);j.doubleSided=!0;j.frustumCulled=!1;return tQuery(j)});
